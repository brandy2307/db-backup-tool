<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Backup Tool - Secure</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header">
        <h1>üõ°Ô∏è Database Backup Tool</h1>
        <p>Sichere Datenbank-Backups mit erweiterten Sicherheitsfunktionen</p>
        <div class="security-badges">
            <span class="security-badge">üîê HTTPS</span>
            <span class="security-badge">üõ°Ô∏è 2FA</span>
            <span class="security-badge">ü§ñ CAPTCHA</span>
            <span class="security-badge">üîí Verschl√ºsselung</span>
        </div>
    </div>

    <div class="container">
        <div id="login-section">
            <div class="login-form">
                <h2>üîê Sichere Anmeldung</h2>
                
                <div class="security-status">
                    <div class="security-indicator">
                        <div class="icon secure"></div>
                        <span>Verbindung verschl√ºsselt</span>
                    </div>
                    <div class="security-indicator">
                        <div class="icon secure"></div>
                        <span>Brute-Force Schutz aktiv</span>
                    </div>
                    <div class="security-indicator">
                        <div class="icon secure"></div>
                        <span>Session-Sicherheit</span>
                    </div>
                </div>

                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">üë§ Benutzername:</label>
                        <input type="text" id="username" required autocomplete="username">
                    </div>

                    <div class="form-group">
                        <label for="password">üîë Passwort:</label>
                        <input type="password" id="password" required autocomplete="current-password">
                        <div class="password-strength hidden">
                            <div class="password-strength-bar"></div>
                        </div>
                    </div>

                    <!-- CAPTCHA Container (wird dynamisch eingeblendet) -->
                    <div id="captcha-container" class="captcha-container hidden">
                        <h4>ü§ñ Sicherheitspr√ºfung</h4>
                        <div class="captcha-display">
                            <div id="captcha-image" class="captcha-image"></div>
                            <button type="button" class="captcha-refresh" onclick="refreshCaptcha()">üîÑ</button>
                        </div>
                        <div class="form-group">
                            <label for="captcha-text">Code eingeben:</label>
                            <input type="text" id="captcha-text" placeholder="Code hier eingeben" autocomplete="off">
                        </div>
                    </div>

                    <!-- 2FA Container (wird dynamisch eingeblendet) -->
                    <div id="two-factor-container" class="two-factor-container hidden">
                        <h4>üîê Zwei-Faktor-Authentifizierung</h4>
                        <p>Bitte gib den 6-stelligen Code aus deiner Authenticator-App ein:</p>
                        <div class="form-group">
                            <label for="two-factor-token">2FA-Code:</label>
                            <input type="text" id="two-factor-token" placeholder="123456" maxlength="6" autocomplete="one-time-code">
                        </div>
                    </div>

                    <div class="remember-me">
                        <input type="checkbox" id="remember-me">
                        <label for="remember-me">Angemeldet bleiben (7 Tage)</label>
                    </div>

                    <button type="submit" id="login-button">
                        <span id="login-text">Anmelden</span>
                    </button>
                </form>
                <div id="loginError" class="error"></div>
            </div>
        </div>

        <div id="main-content" class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('backup')">Backup erstellen</button>
                <button class="tab" onclick="showTab('backups')">Backups verwalten</button>
                <button class="tab" onclick="showTab('schedule')">Zeitplan</button>
                <button class="tab" onclick="showTab('git-backup')">Git Backup</button>
                <button class="tab" onclick="showTab('security')">üõ°Ô∏è Sicherheit</button>
                <button class="tab" onclick="showTab('system')">System</button>
            </div>

            <div id="backup-content" class="tab-content active">
                <h2>Neues Backup erstellen</h2>
                <form id="backupForm" class="backup-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbType">Datenbanktyp:</label>
                            <select id="dbType" required>
                                <option value="">W√§hle Typ...</option>
                                <option value="mysql">MySQL</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mongodb">MongoDB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dbHost">Host:</label>
                            <input type="text" id="dbHost" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbPort">Port:</label>
                            <input type="number" id="dbPort">
                        </div>
                        <div class="form-group">
                            <label for="dbName">Datenbankname:</label>
                            <input type="text" id="dbName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbUsername">Benutzername:</label>
                            <input type="text" id="dbUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="dbPassword">Passwort:</label>
                            <input type="password" id="dbPassword" required>
                        </div>
                    </div>
                    <button type="submit">Backup erstellen</button>
                </form>
                <div id="backupResult"></div>
            </div>

            <div id="backups-content" class="tab-content">
                <h2>Backup-Verwaltung</h2>
                <button onclick="loadBackups()">Aktualisieren</button>
                <div id="backupsList" class="backup-list"></div>
            </div>

            <div id="schedule-content" class="tab-content">
                <h2>Backup-Zeitpl√§ne</h2>
                <form id="scheduleForm" class="backup-form">
                    <div class="form-group">
                        <label for="scheduleName">Name:</label>
                        <input type="text" id="scheduleName" required>
                    </div>
                    <div class="form-group">
                        <label for="cronExpression">Cron-Expression:</label>
                        <input type="text" id="cronExpression" placeholder="0 2 * * *" required>
                        <small>Beispiel: "0 2 * * *" = t√§glich um 2:00 Uhr</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleDbType">Datenbanktyp:</label>
                            <select id="scheduleDbType" required>
                                <option value="">W√§hle Typ...</option>
                                <option value="mysql">MySQL</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mongodb">MongoDB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="scheduleDbHost">Host:</label>
                            <input type="text" id="scheduleDbHost" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleDbPort">Port:</label>
                            <input type="number" id="scheduleDbPort">
                        </div>
                        <div class="form-group">
                            <label for="scheduleDbName">Datenbankname:</label>
                            <input type="text" id="scheduleDbName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleDbUsername">Benutzername:</label>
                            <input type="text" id="scheduleDbUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="scheduleDbPassword">Passwort:</label>
                            <input type="password" id="scheduleDbPassword" required>
                        </div>
                    </div>
                    <button type="submit">Zeitplan erstellen</button>
                </form>
                <div id="scheduleResult"></div>
                <div id="schedulesList" class="backup-list"></div>
            </div>

            <div id="git-backup-content" class="tab-content">
                <h2>Git Backup Konfiguration</h2>
                
                <div class="git-backup-info">
                    <h4>üì§ Automatisches Git Backup</h4>
                    <p>Sende deine Backups automatisch zu GitHub, GitLab oder anderen Git-Repositories.</p>
                    <p><strong>Funktionen:</strong></p>
                    <ul>
                        <li>‚úÖ Automatischer Push nach jedem Backup</li>
                        <li>‚úÖ Intelligentes Cleanup alter Backups</li>
                        <li>‚úÖ Unterst√ºtzung f√ºr GitHub, GitLab, Bitbucket, etc.</li>
                        <li>‚úÖ Sichere Token-basierte Authentifizierung</li>
                        <li>‚úÖ Separate Git-Repository Verwaltung</li>
                    </ul>
                </div>

                <form id="gitBackupForm" class="backup-form">
                    <div class="form-group">
                        <label for="gitBackupEnabled">
                            <input type="checkbox" id="gitBackupEnabled"> Git Backup aktivieren
                        </label>
                        <small>Aktiviere automatisches Pushen von Backups zu einem Git Repository</small>
                    </div>

                    <div class="git-config-field form-group" style="display: none;">
                        <label for="gitBackupRepository">Git Repository URL:</label>
                        <input type="url" id="gitBackupRepository" placeholder="https://github.com/username/backup-repo.git">
                        <small>HTTPS URL deines Git Repositories (GitHub, GitLab, Bitbucket, etc.)</small>
                    </div>

                    <div class="git-config-field form-row" style="display: none;">
                        <div class="form-group">
                            <label for="gitBackupUsername">Benutzername:</label>
                            <input type="text" id="gitBackupUsername" placeholder="dein-git-username">
                            <small>Dein Git-Benutzername</small>
                        </div>
                        <div class="form-group">
                            <label for="gitBackupBranch">Branch:</label>
                            <input type="text" id="gitBackupBranch" placeholder="main" value="main">
                            <small>Git Branch (Standard: main)</small>
                        </div>
                    </div>

                    <div class="git-config-field form-group" style="display: none;">
                        <label for="gitBackupToken">Personal Access Token:</label>
                        <input type="password" id="gitBackupToken" placeholder="Personal Access Token oder App Password">
                        <small>
                            <strong>GitHub:</strong> Settings ‚Üí Developer settings ‚Üí Personal access tokens<br>
                            <strong>GitLab:</strong> User Settings ‚Üí Access Tokens<br>
                            <strong>Bitbucket:</strong> Personal settings ‚Üí App passwords<br>
                            <em>Ben√∂tigte Berechtigung: Repository read/write access</em>
                        </small>
                    </div>

                    <div class="git-config-field" style="display: none;">
                        <button type="submit">Konfiguration speichern</button>
                        <button type="button" id="testGitBackup" onclick="testGitBackup()" style="background: #f39c12; margin-left: 10px;">Verbindung testen</button>
                    </div>
                </form>

                <div id="gitBackupResult"></div>

                <div class="git-backup-help" style="margin-top: 30px;">
                    <h4>üìã Setup-Anleitung</h4>
                    <div class="help-section">
                        <h5>üîµ GitHub Setup:</h5>
                        <ol>
                            <li>Erstelle ein neues Repository auf GitHub (kann privat sein)</li>
                            <li>Gehe zu Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)</li>
                            <li>Erstelle einen neuen Token mit "repo" Berechtigung</li>
                            <li>Trage Repository URL, Benutzername und Token hier ein</li>
                        </ol>
                    </div>

                    <div class="help-section">
                        <h5>üü† GitLab Setup:</h5>
                        <ol>
                            <li>Erstelle ein neues Projekt auf GitLab</li>
                            <li>Gehe zu User Settings ‚Üí Access Tokens</li>
                            <li>Erstelle einen Token mit "write_repository" Berechtigung</li>
                            <li>Verwende die HTTPS Clone-URL deines Projekts</li>
                        </ol>
                    </div>

                    <div class="help-section">
                        <h5>üî¥ Bitbucket Setup:</h5>
                        <ol>
                            <li>Erstelle ein neues Repository auf Bitbucket</li>
                            <li>Gehe zu Personal settings ‚Üí App passwords</li>
                            <li>Erstelle ein App-Passwort mit "Repositories: Write" Berechtigung</li>
                            <li>Verwende die HTTPS Clone-URL deines Repositories</li>
                        </ol>
                    </div>

                    <div class="help-section">
                        <h5>‚öôÔ∏è Funktionsweise:</h5>
                        <ul>
                            <li>Nach jedem erfolgreichen Backup wird die Datei automatisch zum Git Repository gepusht</li>
                            <li>Bei Erreichen der maximalen Backup-Anzahl werden die √§ltesten Backups auch aus dem Git Repository entfernt</li>
                            <li>MongoDB Backups (Verzeichnisse) werden derzeit nicht unterst√ºtzt - nur SQL-Dateien</li>
                            <li>Das Git Repository wird separat in <code>backups/git-backup/</code> verwaltet</li>
                            <li>Deine lokalen Backups bleiben unver√§ndert - Git Backup ist eine zus√§tzliche Sicherung</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- SECURITY TAB -->
            <div id="security-content" class="tab-content">
                <h2>üõ°Ô∏è Sicherheits-Zentrale</h2>

                <!-- Security Overview -->
                <div class="security-section">
                    <h3>üìä Sicherheits-√úbersicht</h3>
                    <div class="security-metrics" id="security-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="active-sessions-count">-</div>
                            <div class="metric-label">Aktive Sessions</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="failed-attempts-count">-</div>
                            <div class="metric-label">Fehlversuche</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="security-level">-</div>
                            <div class="metric-label">Sicherheitslevel</div>
                        </div>
                    </div>
                    <div id="security-overview-result"></div>
                </div>

                <!-- 2FA Management -->
                <div class="security-section">
                    <h3>üîê Zwei-Faktor-Authentifizierung</h3>
                    <div id="2fa-status">
                        <p>Lade 2FA Status...</p>
                    </div>
                    <div class="security-actions">
                        <button class="security-btn primary" onclick="setup2FA()" id="setup-2fa-btn">2FA Einrichten</button>
                        <button class="security-btn danger" onclick="disable2FA()" id="disable-2fa-btn" style="display: none;">2FA Deaktivieren</button>
                    </div>
                    <div id="qr-code-container" class="qr-code-container" style="display: none;"></div>
                    <div id="2fa-result"></div>
                </div>

                <!-- Password Management -->
                <div class="security-section">
                    <h3>üîë Passwort-Verwaltung</h3>
                    <p>Stelle sicher, dass dein Passwort den Sicherheitsanforderungen entspricht.</p>
                    <div class="security-actions">
                        <button class="security-btn warning" onclick="changePassword()">Passwort √§ndern</button>
                        <button class="security-btn primary" onclick="showPasswordRequirements()">Passwort-Anforderungen</button>
                    </div>
                    <div id="password-requirements" style="display: none; margin-top: 15px;">
                        <h4>Passwort-Anforderungen:</h4>
                        <ul style="color: #aaa; margin-left: 20px;">
                            <li>Mindestens 12 Zeichen</li>
                            <li>Mindestens einen Gro√übuchstaben</li>
                            <li>Mindestens einen Kleinbuchstaben</li>
                            <li>Mindestens eine Zahl</li>
                            <li>Mindestens ein Sonderzeichen</li>
                        </ul>
                    </div>
                    <div id="password-result"></div>
                </div>

                <!-- Session Management -->
                <div class="security-section">
                    <h3>üñ•Ô∏è Session-Verwaltung</h3>
                    <p>√úberwache und verwalte deine aktiven Anmeldungen.</p>
                    <div class="security-actions">
                        <button class="security-btn primary" onclick="loadActiveSessions()">Sessions laden</button>
                        <button class="security-btn danger" onclick="terminateAllOtherSessions()">Andere Sessions beenden</button>
                    </div>
                    <div id="active-sessions-list" class="sessions-list"></div>
                    <div id="sessions-result"></div>
                </div>

                <!-- Security Settings -->
                <div class="security-section">
                    <h3>‚öôÔ∏è Sicherheits-Einstellungen</h3>
                    <div id="security-settings-info">
                        <p>Lade Sicherheits-Einstellungen...</p>
                    </div>
                    <div class="security-actions">
                        <button class="security-btn primary" onclick="refreshSecurityInfo()">Einstellungen aktualisieren</button>
                    </div>
                    <div id="security-settings-result"></div>
                </div>

                <!-- Security Log -->
                <div class="security-section">
                    <h3>üìã Sicherheits-Protokoll</h3>
                    <p>Aktuelle Sicherheitsereignisse und -warnungen.</p>
                    <div id="security-log">
                        <div class="alert info">
                            <strong>‚ÑπÔ∏è Info:</strong> Sicherheits-Protokollierung ist aktiv.
                        </div>
                    </div>
                </div>

                <!-- Security Tips -->
                <div class="security-section">
                    <h3>üí° Sicherheits-Tipps</h3>
                    <div class="security-tips">
                        <div class="alert info">
                            <strong>üîê Tipp:</strong> Aktiviere 2FA f√ºr zus√§tzliche Sicherheit deines Accounts.
                        </div>
                        <div class="alert warning">
                            <strong>‚ö†Ô∏è Wichtig:</strong> Verwende f√ºr jede Anwendung ein einzigartiges, starkes Passwort.
                        </div>
                        <div class="alert success">
                            <strong>‚úÖ Empfehlung:</strong> √úberwache regelm√§√üig deine aktiven Sessions und beende unbekannte.
                        </div>
                    </div>
                </div>
            </div>

            <div id="system-content" class="tab-content">
                <h2>System-Informationen</h2>
                
                <div class="repo-info">
                    <h4>üîÑ Offizielles Update-Repository</h4>
                    <p><strong>Repository:</strong> <span id="repo-url">Lade...</span></p>
                    <p><strong>Branch:</strong> <span id="repo-branch">Lade...</span></p>
                    <p><strong>Updates:</strong> Automatisch vom offiziellen Repository</p>
                </div>

                <div class="repo-info" style="background: #e8f4fd; border-left-color: #3498db;">
                    <h4>üì§ Git Backup Status</h4>
                    <div id="git-backup-status">Lade...</div>
                </div>
                
                <div id="systemInfo" class="system-info">
                    <h3>L√§dt System-Informationen...</h3>
                </div>
                <button onclick="manualUpdate()" class="update-button">Manuelles Update</button>
                <div id="updateResult"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="logout()">Abmelden</button>
            </div>
        </div>
    </div>

    <script>
        // Security Tab Functions
        function showPasswordRequirements() {
            const reqDiv = document.getElementById('password-requirements');
            if (reqDiv.style.display === 'none') {
                reqDiv.style.display = 'block';
            } else {
                reqDiv.style.display = 'none';
            }
        }

        async function refreshSecurityInfo() {
            try {
                await checkSecurityStatus();
                
                if (securityInfo) {
                    updateSecurityDisplay();
                    showSuccess('security-settings-result', 'Sicherheits-Informationen aktualisiert');
                }
            } catch (error) {
                showError('security-settings-result', 'Fehler beim Laden der Sicherheits-Informationen');
            }
        }

        function updateSecurityDisplay() {
            if (!securityInfo) return;
            
            // Update metrics
            const activeSessionsCount = document.getElementById('active-sessions-count');
            const securityLevel = document.getElementById('security-level');
            
            if (activeSessionsCount) {
                activeSessionsCount.textContent = securityInfo.activeSessions || '0';
            }
            
            if (securityLevel) {
                let level = 'Niedrig';
                let levelClass = 'danger';
                
                if (securityInfo.has2FA && securityInfo.httpsEnabled && securityInfo.strongPasswordsEnabled) {
                    level = 'Hoch';
                    levelClass = 'secure';
                } else if (securityInfo.httpsEnabled || securityInfo.has2FA) {
                    level = 'Mittel';
                    levelClass = 'warning';
                }
                
                securityLevel.textContent = level;
                securityLevel.parentElement.className = `metric-card ${levelClass}`;
            }
            
            // Update 2FA Status
            const twoFAStatus = document.getElementById('2fa-status');
            const setup2FABtn = document.getElementById('setup-2fa-btn');
            const disable2FABtn = document.getElementById('disable-2fa-btn');
            
            if (twoFAStatus) {
                if (securityInfo.has2FA) {
                    twoFAStatus.innerHTML = `
                        <div class="alert success">
                            <strong>‚úÖ 2FA ist aktiviert</strong><br>
                            Dein Account ist mit Zwei-Faktor-Authentifizierung gesch√ºtzt.
                        </div>
                    `;
                    if (setup2FABtn) setup2FABtn.style.display = 'none';
                    if (disable2FABtn) disable2FABtn.style.display = 'inline-block';
                } else {
                    twoFAStatus.innerHTML = `
                        <div class="alert warning">
                            <strong>‚ö†Ô∏è 2FA ist nicht aktiviert</strong><br>
                            Aktiviere 2FA f√ºr zus√§tzliche Sicherheit.
                        </div>
                    `;
                    if (setup2FABtn) setup2FABtn.style.display = 'inline-block';
                    if (disable2FABtn) disable2FABtn.style.display = 'none';
                }
            }
            
            // Update Security Settings Info
            const securitySettingsInfo = document.getElementById('security-settings-info');
            if (securitySettingsInfo) {
                securitySettingsInfo.innerHTML = `
                    <div class="security-status-grid">
                        <div class="security-card ${securityInfo.httpsEnabled ? 'secure' : 'warning'}">
                            <h4>üîê HTTPS</h4>
                            <div class="value">${securityInfo.httpsEnabled ? 'AN' : 'AUS'}</div>
                        </div>
                        <div class="security-card ${securityInfo.has2FA ? 'secure' : 'warning'}">
                            <h4>üõ°Ô∏è 2FA</h4>
                            <div class="value">${securityInfo.has2FA ? 'AN' : 'AUS'}</div>
                        </div>
                        <div class="security-card ${securityInfo.strongPasswordsEnabled ? 'secure' : 'warning'}">
                            <h4>üîë Starke Passw√∂rter</h4>
                            <div class="value">${securityInfo.strongPasswordsEnabled ? 'AN' : 'AUS'}</div>
                        </div>
                    </div>
                    <p><strong>Session Timeout:</strong> ${securityInfo.sessionTimeout} Minuten</p>
                    <p><strong>Max. Login-Versuche:</strong> ${securityInfo.maxFailedAttempts}</p>
                    <p><strong>CAPTCHA Schwelle:</strong> ${securityInfo.captchaThreshold} Fehlversuche</p>
                    <p><strong>Letzter Login:</strong> ${securityInfo.lastLogin ? new Date(securityInfo.lastLogin).toLocaleString('de-DE') : 'Unbekannt'}</p>
                `;
            }
        }

        async function terminateAllOtherSessions() {
            if (confirm('Alle anderen Sessions beenden? Du bleibst nur in der aktuellen Session angemeldet.')) {
                try {
                    const response = await makeAuthenticatedRequest('/api/active-sessions');
                    const data = await response.json();
                    
                    if (response.ok) {
                        const otherSessions = data.sessions.filter(session => !session.current);
                        
                        for (const session of otherSessions) {
                            await makeAuthenticatedRequest(`/api/session/${session.id}`, {
                                method: 'DELETE'
                            });
                        }
                        
                        showSuccess('sessions-result', `${otherSessions.length} andere Sessions beendet`);
                        loadActiveSessions();
                    }
                } catch (error) {
                    showError('sessions-result', 'Fehler beim Beenden der Sessions: ' + error.message);
                }
            }
        }

        // Initialize security display when tab is opened
        function initSecurityTab() {
            refreshSecurityInfo();
            loadActiveSessions();
        }

        // Override showTab function to handle security tab
        const originalShowTab = showTab;
        function showTab(tabName) {
            originalShowTab(tabName);
            if (tabName === 'security') {
                initSecurityTab();
            }
        }
    </script>

    <script src="app.js"></script>
</body>
</html>